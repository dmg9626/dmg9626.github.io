---
layout: post
title:  "Dev Blog 4: Procedural Map Generation"
# coverImage: "/assets/images/games/surface-tension/cover.png"
category: blog
post_id: proc-gen
---

***Note:** The [A4Engine game engine](https://www.cs.drexel.edu/~santi/teaching/2017/CS387/PCG/){:target="_blank"} and [extended TMX map format](https://www.cs.drexel.edu/~santi/teaching/2017/CS387/PCG/A4Reference2.3.html){:target="_blank"}, both developed by Prof. Santiago Ontañón, were used for playing the maps generated by my program. Further documentation can be found [here](https://www.cs.drexel.edu/~santi/teaching/2017/CS387/PCG/A4Reference2.3.html){:target="_blank"}.*

This project was [another assignment](https://www.cs.drexel.edu/~santi/teaching/2017/CS387/PCG/projectA4PCGv2.3.html){:target="_blank"} from my Game AI course: 

> Implement a procedural map generator that creates playable maps for the A4Engine. 
> It can generate dungeons, outdoors maps (with grass, rivers, trees, rocks, paths, etc.), or interiors - it's up to you.
> It must adhere to the [TMX map format](http://doc.mapeditor.org/en/stable/reference/tmx-map-format/){:target="_blank"}.

Most of my friends generated dungeons with their solutions, using the Kruskal algorithm to generate maze-like environments (this approach was suggested by the professor). I wanted to try something different, so I went about generating a outdoor landscape environment.

My plan was to generate a 2D heightmap - a grid of numbers between 0 and 1 that represent the height at each tile. Once I could generate that that, I'd determine some altitude to be the water level; every tile with a height above that level would be land, and everything below would be water. I wasn't sure what would come next, but I knew that'd be enough to start generating some very basic environments.

----
### Step 1: Generate the Heightmap

To be clear, I didn't plan on having any actual verticality in the maps generated! I was just combining a heightmap and a water level to create an insteresting arrangement of land and water.

##### Take something like this...
<img src="/assets/images/blog/proc-gen/heightmap_3d_reference.png" class="blog text-center" width="75%">

##### ...and turn it into something like this:
<img src="/assets/images/blog/proc-gen/heightmap_2d_reference.png" class="blog text-center" width="75%">

*Note: my maps are generated at a much lower resolution - think Final Fantasy or Pokemon*

I used the [diamond-square algorithm](https://en.wikipedia.org/wiki/Diamond-square_algorithm){:target="_blank"} to generate the heightmaps. It starts with intial height values in the corners and iteratively performs "Diamond" and "Square" averaging operations, forming increasingly granular diamonds/squares from the populated grid points until all points have been filled in. Each Diamond and Square operation applies a bit of "noise" so we don't get boring, perfectly-smooth maps.

<img src="/assets/images/blog/proc-gen/diamond_square.png" class="blog text-center" width="100%">

This limited me to square-shaped maps, but I didn't have a problem with that.

I'd start with a heightmap with preset corner values:

```
0.22    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.09

0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

0.32    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.60
```

And the diamond-square algorithm populates the rest of the map:

```
0.22    0.24    0.24    0.24    0.22    0.21    0.19    0.16    0.09

0.25    0.26    0.22    0.24    0.21    0.23    0.18    0.20    0.18

0.28    0.23    0.13    0.17    0.12    0.16    0.11    0.21    0.24

0.29    0.25    0.16    0.17    0.14    0.17    0.17    0.26    0.29

0.32    0.24    0.11    0.14    0.09    0.15    0.11    0.27    0.36

0.31    0.27    0.18    0.21    0.16    0.24    0.21    0.34    0.40

0.32    0.25    0.12    0.18    0.11    0.20    0.15    0.36    0.48

0.31    0.28    0.26    0.26    0.28    0.30    0.35    0.43    0.51

0.32    0.33    0.36    0.36    0.43    0.42    0.49    0.51    0.60
```

This was nice because I could control the types of maps being generated by specifying certain corner values. For example, if I want a valley running from the top-right to the bottom-left of the map, I'd set low values in those corners, and high values in the top-left/bottom-right corners.

----
### Step 2: Calculate the Water Level

My first inclination here was to set a fixed water level to be used on all maps generated. I figured that, if I was generating random height values between 0 and 1, I could set a fixed water level and it'd result in roughly a proportional ratio of water to land (ex. water level of .15 = 15% of tiles are water). So I plugged in a water level of .15:

<img src="/assets/images/blog/proc-gen/water-level/fixed/15-percent-1.png" class="blog text-center" width="400px">

Hmm, that's much more water than I expected, but maybe that was an unlucky seed. Let's try a few more maps.

<div class="row">
    <img src="/assets/images/blog/proc-gen/water-level/fixed/15-percent-2.png" class="blog text-center" width="400px">
    <img src="/assets/images/blog/proc-gen/water-level/fixed/15-percent-3.png" class="blog text-center" width="400px">
</div>

Maybe I should try a lower water level? I'll plug in .05 and see what we get:

<div class="row">
    <img src="/assets/images/blog/proc-gen/water-level/fixed/5-percent-1.png" class="blog text-center" width="400px">
    <img src="/assets/images/blog/proc-gen/water-level/fixed/5-percent-2.png" class="blog text-center" width="400px">
</div>

We're not getting very consistent results here, and procedural generation is only useful when you can effectively control the content being generated. This step ended up being a bit more involved than I'd anticipated.

I ended up determining a water level for the heightmap generated by calculating the average altitude and multiplying it by some water ratio between 0 and 1. Let's see what we get with a water ratio of 0.55:

<div class="row">
    <img src="/assets/images/blog/proc-gen/water-level/calculated/calculated-1.png" class="blog text-center" width="350px">
    <img src="/assets/images/blog/proc-gen/water-level/calculated/calculated-2.png" class="blog text-center" width="350px">
    <img src="/assets/images/blog/proc-gen/water-level/calculated/calculated-3.png" class="blog text-center" width="350px">
</div>

That's much better! But there's still a lot left to improve here.

----
### Step 3: Clean up the land/water patches

You've probably noticed all those single-tile patches of land/water on the maps generated. This is what happens when you apply a cut-off water level to the jagged landscapes we're generating. I decided to remove any tiles that have no adjacent tiles of the same type.

Here's a visualization of each stage of the cleanup process: before cleanup, cleanup land patches, and cleanup water patches:

<div class="row">
    <img src="/assets/images/blog/proc-gen/cleanup-patches/v1/before-cleanup.png" class="blog text-center" width="350px">
    <img src="/assets/images/blog/proc-gen/cleanup-patches/v1/cleanup-land-patches.png" class="blog text-center" width="350px">
    <img src="/assets/images/blog/proc-gen/cleanup-patches/v1/cleanup-water-patches.png" class="blog text-center" width="350px">
</div>

Hmm... it's a bit better, but we still have those narrow strips jutting in/out of the coast. Let's replace tiles with less than 2 neighbors of the same type:

<div class="row">
    <img src="/assets/images/blog/proc-gen/cleanup-patches/v2/before-cleanup.png" class="blog text-center" width="350px">
    <img src="/assets/images/blog/proc-gen/cleanup-patches/v2/cleanup-land-patches.png" class="blog text-center" width="350px">
    <img src="/assets/images/blog/proc-gen/cleanup-patches/v2/cleanup-water-patches.png" class="blog text-center" width="350px">
</div>

That looks a lot nicer!